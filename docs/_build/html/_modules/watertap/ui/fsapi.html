<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>watertap.ui.fsapi &mdash; WaterTAP 1.0.dev0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=34238251"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../copyright.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            WaterTAP
              <img src="../../../_static/NAWI_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0.dev0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how_to_guides/index.html">How To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../technical_reference/index.html">Technical Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../background/index.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License Agreement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">WaterTAP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">watertap.ui.fsapi</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for watertap.ui.fsapi</h1><div class="highlight"><pre>
<span></span><span class="c1">#################################################################################</span>
<span class="c1"># WaterTAP Copyright (c) 2020-2024, The Regents of the University of California,</span>
<span class="c1"># through Lawrence Berkeley National Laboratory, Oak Ridge National Laboratory,</span>
<span class="c1"># National Renewable Energy Laboratory, and National Energy Technology</span>
<span class="c1"># Laboratory (subject to receipt of any required approvals from the U.S. Dept.</span>
<span class="c1"># of Energy). All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Please see the files COPYRIGHT.md and LICENSE.md for full copyright and license</span>
<span class="c1"># information, respectively. These files are also available online at the URL</span>
<span class="c1"># &quot;https://github.com/watertap-org/watertap/&quot;</span>
<span class="c1">#################################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Simple flowsheet interface API</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Dan Gunter&quot;</span>

<span class="c1"># stdlib</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">csv</span> <span class="kn">import</span> <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">TextIOBase</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">importlib.resources</span> <span class="kn">import</span> <span class="n">files</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">importlib_resources</span> <span class="kn">import</span> <span class="n">files</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">TypeVar</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">ModuleType</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">metadata</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">importlib_metadata</span> <span class="k">as</span> <span class="nn">metadata</span>

<span class="c1"># third-party</span>
<span class="kn">import</span> <span class="nn">idaes.logger</span> <span class="k">as</span> <span class="nn">idaeslog</span>
<span class="kn">from</span> <span class="nn">idaes.core.util.model_statistics</span> <span class="kn">import</span> <span class="n">degrees_of_freedom</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span><span class="p">,</span> <span class="n">ValidationInfo</span><span class="p">,</span> <span class="n">ConfigDict</span>
<span class="kn">import</span> <span class="nn">pyomo.environ</span> <span class="k">as</span> <span class="nn">pyo</span>

<span class="c1">#: Forward-reference to a FlowsheetInterface type, used in</span>
<span class="c1">#: :meth:`FlowsheetInterface.find`</span>
<span class="n">FSI</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;FSI&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;FlowsheetInterface&quot;</span><span class="p">)</span>


<span class="n">_log</span> <span class="o">=</span> <span class="n">idaeslog</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="UnsupportedObjType"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.UnsupportedObjType">[docs]</a><span class="k">class</span> <span class="nc">UnsupportedObjType</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
<div class="viewcode-block" id="UnsupportedObjType.__init__"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.UnsupportedObjType.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">supported</span><span class="p">:</span> <span class="n">Optional</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Object &#39;</span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&#39; of type &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; is not supported.&quot;</span>
        <span class="k">if</span> <span class="n">supported</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Supported: </span><span class="si">{</span><span class="n">supported</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supported</span> <span class="o">=</span> <span class="n">supported</span></div></div>


<div class="viewcode-block" id="ModelExport"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.ModelExport">[docs]</a><span class="k">class</span> <span class="nc">ModelExport</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A variable, expression, or parameter.&quot;&quot;&quot;</span>

    <span class="n">_SupportedObjType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">,</span>
        <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">,</span>
        <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="s2">&quot;Used for type hints and as a shorthand in error messages (i.e. not for runtime checks)&quot;</span>

    <span class="c1"># TODO: if Optional[_SupportedObjType] is used for the `obj` type hint,</span>
    <span class="c1"># pydantic will run the runtime instance check which is not what we want</span>
    <span class="c1"># (as we want/need to use the pyomo is_xxx_type() methods instead)</span>
    <span class="c1"># so we&#39;re using Optional[object] unless we find a way to tell pydantic to skip this check</span>
    <span class="c1"># inputs</span>
    <span class="n">obj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">ui_units</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">display_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">rounding</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">is_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">is_readonly</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">input_category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">output_category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">chart_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">chart_group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># computed</span>
    <span class="n">obj_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fixed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">lb</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">ub</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">has_bounds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">is_sweep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;obj&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">ensure_obj_is_supported</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_ensure_supported_type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_ensure_supported_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
        <span class="n">is_valid</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">is_variable_type</span><span class="p">()</span>
            <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_expression_type</span><span class="p">()</span>
            <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_parameter_type</span><span class="p">()</span>
            <span class="c1"># TODO: add support for numbers with pyo.numvalue.is_numeric_data()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_valid</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">raise</span> <span class="n">UnsupportedObjType</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_SupportedObjType</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_supported_obj</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;obj&quot;</span><span class="p">,</span> <span class="n">allow_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_none</span> <span class="ow">and</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; is None but allow_none is False&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_ensure_supported_type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="c1"># NOTE: IMPORTANT: all validators used to set a dynamic default value</span>
    <span class="c1"># should have the `always=True` option, or the validator won&#39;t be called</span>
    <span class="c1"># when the value for that field is not passed</span>
    <span class="c1"># (which is precisely when we need the default value)</span>
    <span class="c1"># additionally, `pre=True` should be given if the field can at any point</span>
    <span class="c1"># have a value that doesn&#39;t match its type annotation</span>
    <span class="c1"># (e.g. `None` for a strict (non-`Optional` `bool` field)</span>

    <span class="c1"># Get value from object</span>
    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_value</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">ValidationInfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;obj&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_supported_obj</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="c1"># Derive display_units from ui_units</span>
    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;display_units&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_units</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">ValidationInfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ui_units&quot;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">get_units</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="c1"># set name dynamically from object</span>
    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">ValidationInfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_supported_obj</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;is_readonly&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_readonly_default</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">ValidationInfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_supported_obj</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_variable_type</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">is_parameter_type</span><span class="p">()</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">parent_component</span><span class="p">()</span><span class="o">.</span><span class="n">mutable</span>
            <span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;obj_key&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_obj_key_default</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">ValidationInfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_supported_obj</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span></div>


<div class="viewcode-block" id="ModelOption"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.ModelOption">[docs]</a><span class="k">class</span> <span class="nc">ModelOption</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An option for building/running the model.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">category</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Build Options&quot;</span>
    <span class="n">display_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">display_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">values_allowed</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
    <span class="n">min_val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;display_name&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_display_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">ValidationInfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_description</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">ValidationInfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;display_name&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_value</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">ValidationInfo</span><span class="p">):</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;values_allowed&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># check if values allowed is int or float and ensure valid value</span>
        <span class="k">if</span> <span class="n">allowed</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">min_val</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_val&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">))</span>
                <span class="n">max_val</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_val&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">min_val</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">max_val</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;&#39;value&#39; (</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">) not within expected range of [</span><span class="si">{</span><span class="n">min_val</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">max_val</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;value&#39; (</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">) not a valid integer&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">allowed</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">min_val</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_val&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">))</span>
                <span class="n">max_val</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_val&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">min_val</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">max_val</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;&#39;value&#39; (</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">) not within expected range of [</span><span class="si">{</span><span class="n">min_val</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">max_val</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;value&#39; (</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">) not a valid float&quot;</span><span class="p">)</span>
        <span class="c1"># check if values allowed is string</span>
        <span class="k">elif</span> <span class="n">allowed</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;value&#39; (</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">) not a valid string&quot;</span><span class="p">)</span>
        <span class="c1"># values_allowed is a list. make sure v is in the list of values allowed</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">allowed</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;value&#39; (</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">) not in allowed values: </span><span class="si">{</span><span class="n">allowed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">allowed</span><span class="si">}</span><span class="s2"> does not match the following criteria for values_allowed: must be either a list of possible values, or one of &#39;string&#39;, &#39;int&#39;, &#39;float&#39;.&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="FlowsheetExport"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetExport">[docs]</a><span class="k">class</span> <span class="nc">FlowsheetExport</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A flowsheet and its contained exported model objects.&quot;&quot;&quot;</span>

    <span class="n">m</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">validate_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">validate_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">exports</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelExport</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">requires_idaes_solver</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dof</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sweep_results</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">build_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelOption</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># set name dynamically from object</span>
    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">ValidationInfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_description</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">ValidationInfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">doc</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> flowsheet&quot;</span>
        <span class="k">return</span> <span class="n">v</span>

<div class="viewcode-block" id="FlowsheetExport.add"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetExport.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">ModelExport</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new variable (or other model object).</span>

<span class="sd">        There are a few different ways of invoking this function. Users will</span>
<span class="sd">        typically use this form::</span>

<span class="sd">            add(obj=&lt;pyomo object&gt;, name=&quot;My value name&quot;, ..etc..)</span>

<span class="sd">        where the keywords after `obj` match the non-computed names in :class:`ModelExport`.</span>

<span class="sd">        If these same name/value pairs are already in a dictionary, this form is more</span>
<span class="sd">        convenient::</span>

<span class="sd">            add(data=my_dict_of_name_value_pairs)</span>

<span class="sd">        If you have an existing ModelExport object, you can add it more directly with::</span>

<span class="sd">            add(my_object)</span>
<span class="sd">            # -- OR --</span>
<span class="sd">            add(data=my_object)</span>


<span class="sd">        Args:</span>
<span class="sd">            *args: If present, should be a single non-named argument, which is a</span>
<span class="sd">                 ModelExport object. Create by adding it.</span>
<span class="sd">            data: If present, create from this argument. If it&#39;s a dict, create from</span>
<span class="sd">                 its values just as from the kwargs. Otherwise, it should be a</span>
<span class="sd">                 ModelExport object, and create by adding it.</span>
<span class="sd">            kwargs: Name/value pairs to create a ModelExport object.</span>
<span class="sd">                    Accepted names and default values are in the ModelExport.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If the name of the Pyomo object is the same as an existing one,</span>
<span class="sd">                i.e. refuse to overwrite.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;At most one non-keyword arg allowed. Got: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">model_export</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Create ModelExport from args: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model_export</span> <span class="o">=</span> <span class="n">ModelExport</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">model_export</span> <span class="o">=</span> <span class="n">ModelExport</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model_export</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">model_export</span><span class="o">.</span><span class="n">obj_key</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exports</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Adding ModelExport object failed: duplicate key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; (model_export=</span><span class="si">{</span><span class="n">model_export</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">_log</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>  <span class="c1"># skip except in debug mode</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Adding ModelExport object with key=</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">model_export</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exports</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_export</span>
        <span class="k">return</span> <span class="n">model_export</span></div>

<div class="viewcode-block" id="FlowsheetExport.from_csv"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetExport.from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span> <span class="n">flowsheet</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load multiple exports from the given CSV file.</span>

<span class="sd">        CSV file format rules:</span>

<span class="sd">            * Always use a header row. The names are case-insensitive, order is</span>
<span class="sd">              not important. The &#39;name&#39;, &#39;obj&#39;, and &#39;ui_units&#39; columns are required.</span>
<span class="sd">            * Columns names should match the non-computed names in :class:`ModelExport`.</span>
<span class="sd">              See `.add()` for a list.</span>
<span class="sd">            * The object to export should be in a column named &#39;obj&#39;, prefixed with &#39;fs.&#39;</span>
<span class="sd">            * For units, use Pyomo units module as &#39;units&#39;, e.g., &#39;mg/L&#39; is `units.mg / units.L`</span>

<span class="sd">        For example::</span>

<span class="sd">            name,obj,description,ui_units,display_units,rounding,is_input,input_category,is_output,output_category</span>
<span class="sd">            Leach liquid feed rate,fs.leach_liquid_feed.flow_vol[0],Leach liquid feed volumetric flow rate,units.L/units.hour,L/h,2,TRUE,Liquid feed,FALSE,</span>
<span class="sd">            Leach liquid feed H,&quot;fs.leach_liquid_feed.conc_mass_comp[0,&#39;H&#39;]&quot;,Leach liquid feed hydrogen mass composition,units.mg/units.L,mg/L,3,TRUE,Liquid feed,FALSE,</span>
<span class="sd">            .......etc.......</span>

<span class="sd">        Args:</span>
<span class="sd">            file: Filename or path. If not an absolute path, start from the</span>
<span class="sd">                  directory of the caller&#39;s file.</span>
<span class="sd">            flowsheet: Flowsheet used to evaluate the exported objects.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Number of exports added</span>

<span class="sd">        Raises:</span>
<span class="sd">            IOError: if input file doesn&#39;t exist</span>
<span class="sd">            ValueError: Invalid data in input file (error message will have details)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;exports.add: from csv filename=</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># compute path</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="k">else</span> <span class="n">file</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Reading CSV data for interface exports from &quot;</span> <span class="sa">f</span><span class="s2">&quot;absolute path: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">caller</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getouterframes</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">caller_mod</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">caller_mod</span><span class="p">:</span>  <span class="c1"># not in a package</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">file</span>
                <span class="n">text</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">caller_pkg</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">caller_mod</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># strip module</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Reading CSV data for interface exports from: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;file=</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">, module=</span><span class="si">{</span><span class="n">caller_mod</span><span class="si">}</span><span class="s2">, package=</span><span class="si">{</span><span class="n">caller_pkg</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="n">caller_pkg</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not find CSV file &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; relative to file &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;calling .add() in &#39;</span><span class="si">{</span><span class="n">caller_mod</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># process CSV file</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\r?\n&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="c1"># read and pre-process the header row</span>
        <span class="n">raw_header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">raw_header</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;obj&quot;</span><span class="p">,</span> <span class="s2">&quot;ui_units&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">req</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Bad CSV header: &#39;</span><span class="si">{</span><span class="n">req</span><span class="si">}</span><span class="s2">&#39; column is required. data=&quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># build raw dict from values and header</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">row</span><span class="p">)}</span>
            <span class="c1"># evaluate the object in the flowsheet</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;fs&quot;</span><span class="p">:</span> <span class="n">flowsheet</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find object in flowsheet: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># evaluate the units</span>
            <span class="n">norm_units</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ui_units&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">norm_units</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ui_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">dimensionless</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ui_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">norm_units</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">units</span><span class="p">})</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad units &#39;</span><span class="si">{</span><span class="n">norm_units</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># process boolean values (starting with &#39;is_&#39;)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;is_&quot;</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Bad value &#39;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;for boolean argument &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;: &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;must be &#39;true&#39; or &#39;false&#39; &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(case-insensitive)&quot;</span>
                        <span class="p">)</span>
            <span class="c1"># add parsed export</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">num</span></div>

<div class="viewcode-block" id="FlowsheetExport.to_csv"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetExport.to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TextIOBase</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write wrapped objects as CSV.</span>

<span class="sd">        Args:</span>
<span class="sd">            output: Where to write CSV file. Can be a stream, path, or filename.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Number of objects written into file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IOError: If path is given, and not writable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># open file for writing</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">TextIOBase</span><span class="p">):</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="c1"># initialize</span>
        <span class="n">csv_output_file</span> <span class="o">=</span> <span class="n">writer</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

        <span class="c1"># write header row</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exports</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">,</span> <span class="s2">&quot;ui_units&quot;</span><span class="p">]</span>
        <span class="n">col_idx_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()):</span>
            <span class="c1"># add to mapping of field name to column number</span>
            <span class="n">col_idx_map</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="c1"># add column name</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="n">csv_output_file</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># write a row for each object</span>
        <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># initialize values list</span>
            <span class="c1">#   first 2 column values are object name and units</span>
            <span class="n">obj_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_massage_object_name</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">units_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_massage_ui_units</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">ui_units</span><span class="p">))</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj_name</span><span class="p">,</span> <span class="n">units_str</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ncol</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># add columns</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">values</span><span class="p">[</span><span class="n">col_idx_map</span><span class="p">[</span><span class="n">field_name</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field_value</span>
            <span class="c1"># write row</span>
            <span class="n">csv_output_file</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">num</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_massage_object_name</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[([^]]*)\]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;[&#39;\1&#39;]&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>  <span class="c1"># quote everything in [brackets]</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[&#39;([0-9.]+)&#39;\]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;[\1]&quot;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>  <span class="c1"># unquote [0.0] numbers</span>
        <span class="k">return</span> <span class="n">s2</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_massage_ui_units</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;dimensionless&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="FlowsheetExport.add_option"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetExport.add_option">[docs]</a>    <span class="k">def</span> <span class="nf">add_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelOption</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an &#39;option&#39; to the flowsheet that can be displayed and manipulated</span>
<span class="sd">        from the UI.</span>

<span class="sd">        Constructs a :class:`ModelOption` instance with provided args and adds it to</span>
<span class="sd">        the dict of options, keyed by its `name`.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Name of option (internal, for accessing the option)</span>
<span class="sd">            kwargs: Fields of :class:`ModelOption`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">ModelOption</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_options</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span>
        <span class="k">return</span> <span class="n">option</span></div></div>


<div class="viewcode-block" id="Actions"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.Actions">[docs]</a><span class="k">class</span> <span class="nc">Actions</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Known actions that can be run.</span>
<span class="sd">    Actions that users should not run directly (unless they know what they are</span>
<span class="sd">    doing) are prefixed with an underscore.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">build</span> <span class="o">=</span> <span class="s2">&quot;build&quot;</span>
    <span class="n">solve</span> <span class="o">=</span> <span class="s2">&quot;solve&quot;</span>
    <span class="n">export</span> <span class="o">=</span> <span class="s2">&quot;_export&quot;</span>
    <span class="n">diagram</span> <span class="o">=</span> <span class="s2">&quot;diagram&quot;</span></div>


<div class="viewcode-block" id="FlowsheetCategory"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetCategory">[docs]</a><span class="k">class</span> <span class="nc">FlowsheetCategory</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flowsheet Categories&quot;&quot;&quot;</span>

    <span class="n">wastewater</span> <span class="o">=</span> <span class="s2">&quot;Wasterwater Recovery&quot;</span>
    <span class="n">desalination</span> <span class="o">=</span> <span class="s2">&quot;Desalination&quot;</span></div>


<div class="viewcode-block" id="FlowsheetInterface"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface">[docs]</a><span class="k">class</span> <span class="nc">FlowsheetInterface</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface between users, UI developers, and flowsheet models.&quot;&quot;&quot;</span>

    <span class="c1">#: Function to look for in modules. See :meth:`find`.</span>
    <span class="n">UI_HOOK</span> <span class="o">=</span> <span class="s2">&quot;export_to_ui&quot;</span>

    <span class="c1">#: Type of item in list ``MissingObjectError.missing``.</span>
    <span class="c1">#: ``key`` is the unique key assigned to the variable,</span>
    <span class="c1">#: ``name`` is the variable name in the flowsheet</span>
    <span class="n">MissingObject</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;MissingObject&quot;</span><span class="p">,</span> <span class="s2">&quot;key name&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="FlowsheetInterface.MissingObjectError"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.MissingObjectError">[docs]</a>    <span class="k">class</span> <span class="nc">MissingObjectError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Error returned if data in `load` refers to a variable not found in the</span>
<span class="sd">        target object.</span>

<span class="sd">        Use the `.missing` attribute of the error object to get the list  of</span>
<span class="sd">        MissingObjects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FlowsheetInterface.MissingObjectError.__init__"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.MissingObjectError.__init__">[docs]</a>        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">missing</span><span class="p">):</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span>
            <span class="n">plural</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;s&quot;</span>
            <span class="n">things</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">]</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2"> object</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s2"> not found in the model: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">things</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">missing</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">FlowsheetInterface</span><span class="o">.</span><span class="n">MissingObject</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing</span>
            <span class="p">]</span></div></div>

<div class="viewcode-block" id="FlowsheetInterface.__init__"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fs</span><span class="p">:</span> <span class="n">FlowsheetExport</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">do_build</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">do_export</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">do_solve</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">get_diagram</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">category</span><span class="p">:</span> <span class="n">FlowsheetCategory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_do_param_sweep_kwargs</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        Args:</span>
<span class="sd">            fs: An existing wrapper to a flowsheet object. If this is not provided,</span>
<span class="sd">                then one will be constructed by passing the keyword arguments to</span>
<span class="sd">                the built-in pydantic ``parse_obj()`` method</span>
<span class="sd">                of :class:`FlowsheetExport`.</span>
<span class="sd">            do_build: Function to call to build the flowsheet. It should build the</span>
<span class="sd">                flowsheet model and return the `FlowsheetBlock`, which is typically</span>
<span class="sd">                the `fs` attribute of the model object. **Required**</span>
<span class="sd">            do_export: Function to call to export variables after the model is built.</span>
<span class="sd">                This will be called automatically by :meth:`build()`. **Required**</span>
<span class="sd">            do_solve: Function to solve the model. It should return the result</span>
<span class="sd">                that the solver itself returns. **Required**</span>
<span class="sd">            custom_do_param_sweep_kwargs: Option for setting up parallel solver using</span>
<span class="sd">                custom solve function.</span>
<span class="sd">            **kwargs: See `fs` arg. If the `fs` arg *is* provided, these are ignored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span> <span class="o">=</span> <span class="n">FlowsheetExport</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span> <span class="o">=</span> <span class="n">fs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">do_export</span><span class="p">,</span> <span class="s2">&quot;export&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">do_build</span><span class="p">,</span> <span class="s2">&quot;build&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">do_solve</span><span class="p">,</span> <span class="s2">&quot;solve&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">arg</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;do_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; argument must be callable&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">Actions</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;do_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; argument is required&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">get_diagram</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span><span class="s2">&quot;diagram&quot;</span><span class="p">,</span> <span class="n">get_diagram</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span><span class="s2">&quot;diagram&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span><span class="p">[</span><span class="s2">&quot;custom_do_param_sweep_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">custom_do_param_sweep_kwargs</span></div>

<div class="viewcode-block" id="FlowsheetInterface.build"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build flowsheet</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: User-defined values</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the build fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_action</span><span class="p">(</span><span class="n">Actions</span><span class="o">.</span><span class="n">build</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building flowsheet: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="FlowsheetInterface.solve"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solve flowsheet.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: User-defined values</span>

<span class="sd">        Returns:</span>
<span class="sd">            Return value of the underlying solve function</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: if the solver did not terminate in an optimal solution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_action</span><span class="p">(</span><span class="n">Actions</span><span class="o">.</span><span class="n">solve</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solving flowsheet: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="FlowsheetInterface.get_diagram"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.get_diagram">[docs]</a>    <span class="k">def</span> <span class="nf">get_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return diagram image name.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: User-defined values</span>

<span class="sd">        Returns:</span>
<span class="sd">            Return image file name if get_diagram function is callable. Otherwise, return none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">Actions</span><span class="o">.</span><span class="n">diagram</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_action</span><span class="p">(</span><span class="n">Actions</span><span class="o">.</span><span class="n">diagram</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="FlowsheetInterface.dict"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.dict">[docs]</a>    <span class="k">def</span> <span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Serialized contained FlowsheetExport object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;obj&quot;</span><span class="p">})</span></div>

<div class="viewcode-block" id="FlowsheetInterface.load"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load values from the data into corresponding variables in this</span>
<span class="sd">        instance&#39;s FlowsheetObject.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The input flowsheet (probably deserialized from JSON)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">units</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">FlowsheetExport</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># new instance from data</span>
        <span class="c1"># Set the value for each input variable</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># &#39;src&#39; is the data source and &#39;dst&#39; is this flowsheet (destination)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">fs</span><span class="o">.</span><span class="n">exports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># get corresponding exported variable</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">exports</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="c1"># set value in this flowsheet</span>
            <span class="n">ui_units</span> <span class="o">=</span> <span class="n">dst</span><span class="o">.</span><span class="n">ui_units</span>
            <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">is_input</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dst</span><span class="o">.</span><span class="n">is_readonly</span><span class="p">:</span>
                <span class="c1"># only update if value has changed</span>
                <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="c1"># print(f&#39;changing value for {key} from {dst.value} to {src.value}&#39;)</span>
                    <span class="c1"># create a Var so Pyomo can do the unit conversion for us</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">ui_units</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">construct</span><span class="p">()</span>
                    <span class="c1"># Convert units when setting value in the model</span>
                    <span class="n">new_val</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">to_units</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">get_units</span><span class="p">(</span><span class="n">dst</span><span class="o">.</span><span class="n">obj</span><span class="p">)))</span>
                    <span class="c1"># print(f&#39;changing value for {key} from {dst.value} to {new_val}&#39;)</span>
                    <span class="n">dst</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
                    <span class="c1"># Don&#39;t convert units when setting the exported value</span>
                    <span class="n">dst</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">value</span>

                <span class="c1"># update other variable properties if changed, not applicable for parameters</span>
                <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">is_variable_type</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">fixed</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
                        <span class="c1"># print(f&#39;changing fixed for {key} from {dst.obj.fixed} to {src.fixed}&#39;)</span>
                        <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">unfix</span><span class="p">()</span>
                        <span class="n">dst</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">fixed</span>
                    <span class="c1"># update bounds</span>
                    <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">lb</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">lb</span><span class="p">:</span>
                        <span class="c1"># print(f&#39;changing lb for {key} from {dst.lb} to {src.lb}&#39;)</span>
                        <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">src</span><span class="o">.</span><span class="n">lb</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">setlb</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">lb</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">lb</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">ui_units</span><span class="p">)</span>
                            <span class="n">tmp</span><span class="o">.</span><span class="n">construct</span><span class="p">()</span>
                            <span class="n">new_lb</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span>
                                <span class="n">u</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">to_units</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">get_units</span><span class="p">(</span><span class="n">dst</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
                            <span class="p">)</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">setlb</span><span class="p">(</span><span class="n">new_lb</span><span class="p">)</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">lb</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">lb</span>
                    <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">ub</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">ub</span><span class="p">:</span>
                        <span class="c1"># print(f&#39;changing ub for {key} from {dst.ub} to {src.ub}&#39;)</span>
                        <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">src</span><span class="o">.</span><span class="n">ub</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">ub</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">ub</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">ui_units</span><span class="p">)</span>
                            <span class="n">tmp</span><span class="o">.</span><span class="n">construct</span><span class="p">()</span>
                            <span class="n">new_ub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span>
                                <span class="n">u</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">to_units</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">get_units</span><span class="p">(</span><span class="n">dst</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
                            <span class="p">)</span>
                            <span class="c1"># print(f&#39;changing ub for {key} from {dst.obj.ub} to {new_ub}&#39;)</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="n">new_ub</span><span class="p">)</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">ub</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">ub</span>

                <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">is_sweep</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">is_sweep</span><span class="p">:</span>
                    <span class="n">dst</span><span class="o">.</span><span class="n">is_sweep</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">is_sweep</span>

                <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">num_samples</span><span class="p">:</span>
                    <span class="n">dst</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">num_samples</span>

        <span class="c1"># update degrees of freedom (dof)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="n">degrees_of_freedom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">MissingObjectError</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span></div>

<div class="viewcode-block" id="FlowsheetInterface.select_option"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.select_option">[docs]</a>    <span class="k">def</span> <span class="nf">select_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_option</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update flowsheet with selected option.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The input flowsheet</span>
<span class="sd">            option_name: Name of selected option</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># fs = FlowsheetExport.parse_obj(data)  # new instance from data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">build_options</span><span class="p">[</span><span class="n">option_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_option</span></div>

        <span class="c1"># # get function name from model options</span>
        <span class="c1"># func_name = self.fs_exp.build_options[option_name].values_allowed[new_option]</span>

        <span class="c1"># # add functino name as new build function</span>
        <span class="c1"># self.add_action(&quot;build&quot;, func_name)</span>

<div class="viewcode-block" id="FlowsheetInterface.add_action"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.add_action">[docs]</a>    <span class="k">def</span> <span class="nf">add_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an action for the flowsheet.</span>

<span class="sd">        Args:</span>
<span class="sd">            action_name: Name of the action to take (see :class:`Actions`)</span>
<span class="sd">            action_func: Function to call for the action</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(f&#39;ADDING ACTION: {action_name}&#39;)</span>
        <span class="c1"># print(action_func)</span>
        <span class="k">def</span> <span class="nf">action_wrapper</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">action_name</span> <span class="o">==</span> <span class="n">Actions</span><span class="o">.</span><span class="n">build</span><span class="p">:</span>
                <span class="c1"># set new model object from return value of build action</span>
                <span class="n">action_result</span> <span class="o">=</span> <span class="n">action_func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">action_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Flowsheet `</span><span class="si">{</span><span class="n">Actions</span><span class="o">.</span><span class="n">build</span><span class="si">}</span><span class="s2">` action failed. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;See logs for details.&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">action_result</span><span class="o">.</span><span class="n">fs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">action_result</span>
                <span class="c1"># [re-]create exports (new model object)</span>
                <span class="k">if</span> <span class="n">Actions</span><span class="o">.</span><span class="n">export</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                        <span class="s2">&quot;Error in &#39;build&#39; action: no export action defined. &quot;</span>
                        <span class="s2">&quot;Add `do_export=&lt;function&gt;` to FlowsheetInterface &quot;</span>
                        <span class="s2">&quot;constructor or call `add_action(Actions.export, &lt;function&gt;)` &quot;</span>
                        <span class="s2">&quot;on FlowsheetInterface instance.&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># clear exports dict, since duplicates not allowed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">exports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="c1"># use get_action() since run_action() will refuse to call it directly</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">Actions</span><span class="o">.</span><span class="n">export</span><span class="p">)(</span>
                    <span class="n">exports</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="p">,</span> <span class="n">build_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">build_options</span>
                <span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="n">Actions</span><span class="o">.</span><span class="n">diagram</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span><span class="p">[</span><span class="n">action_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">action_func</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot run any flowsheet action (except &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">Actions</span><span class="o">.</span><span class="n">build</span><span class="si">}</span><span class="s2">&#39;) before flowsheet is built&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">action_func</span><span class="p">(</span><span class="n">flowsheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># Issue 755: Report optimization errors</span>
                <span class="k">if</span> <span class="n">action_name</span> <span class="o">==</span> <span class="n">Actions</span><span class="o">.</span><span class="n">solve</span><span class="p">:</span>
                    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solve result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Solver did not return a result&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pyo</span><span class="o">.</span><span class="n">check_optimal_termination</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solve failed: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Sync model with exported values</span>
            <span class="k">if</span> <span class="n">action_name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Actions</span><span class="o">.</span><span class="n">build</span><span class="p">,</span> <span class="n">Actions</span><span class="o">.</span><span class="n">solve</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">export_values</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span><span class="p">[</span><span class="n">action_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">action_wrapper</span></div>

<div class="viewcode-block" id="FlowsheetInterface.get_action"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.get_action">[docs]</a>    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the function for an ``add()``-ed action.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Name of the action (see :class:`Actions`)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Function for this action</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError, if no such action is defined</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>

<div class="viewcode-block" id="FlowsheetInterface.run_action"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.run_action">[docs]</a>    <span class="k">def</span> <span class="nf">run_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the named action.&quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Refusing to call &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; action directly since its &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;name begins with an underscore&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="FlowsheetInterface.export_values"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.export_values">[docs]</a>    <span class="k">def</span> <span class="nf">export_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy current values in underlying Pyomo model into exported model.</span>

<span class="sd">        Side-effects:</span>
<span class="sd">            Attribute ``fs_exp`` is modified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exporting values from flowsheet model to UI&quot;</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="n">degrees_of_freedom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">mo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs_exp</span><span class="o">.</span><span class="n">exports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mo</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">to_units</span><span class="o">=</span><span class="n">mo</span><span class="o">.</span><span class="n">ui_units</span><span class="p">))</span>
            <span class="c1"># print(f&#39;{key} is being set to: {mo.value}&#39;)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">):</span>
                <span class="c1"># print(f&#39;{key} is being set to: {mo.value} from {mo.obj.value}&#39;)</span>
                <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mo</span><span class="o">.</span><span class="n">ub</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">ub</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">mo</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">ub</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">get_units</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">construct</span><span class="p">()</span>
                    <span class="n">mo</span><span class="o">.</span><span class="n">ub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">to_units</span><span class="o">=</span><span class="n">mo</span><span class="o">.</span><span class="n">ui_units</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mo</span><span class="o">.</span><span class="n">lb</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">lb</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">mo</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">lb</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">get_units</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">construct</span><span class="p">()</span>
                    <span class="n">mo</span><span class="o">.</span><span class="n">lb</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">to_units</span><span class="o">=</span><span class="n">mo</span><span class="o">.</span><span class="n">ui_units</span><span class="p">))</span>
                <span class="n">mo</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">fixed</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mo</span><span class="o">.</span><span class="n">has_bounds</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="FlowsheetInterface.from_installed_packages"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.from_installed_packages">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_installed_packages</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">group_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;watertap.flowsheets&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;FlowsheetInterface&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all flowsheet interfaces defined as entry points within the Python packages installed in the environment.</span>

<span class="sd">        This uses the :func:`importlib.metadata.entry_points` function to fetch the</span>
<span class="sd">        list of flowsheets declared as part of a Python package distribution&#39;s `entry points &lt;https://docs.python.org/3/library/importlib.metadata.html#entry-points&gt;`_</span>
<span class="sd">        under the group ``group_name``.</span>

<span class="sd">        To set up a flowsheet interface for discovery, locate your Python package distribution&#39;s file (normally</span>
<span class="sd">        :file:`setup.py`, :file:`pyproject.toml`, or equivalent) and add an entry in the ``entry_points`` section.</span>

<span class="sd">        For example, to add a flowsheet defined in :file:`watertap/flowsheets/flowsheets/my_flowsheet.py`</span>
<span class="sd">        so that it can be discovered with the name ``my_flowsheet`` wherever the ``watertap`` package is installed,</span>
<span class="sd">        the following should be added to WaterTAP&#39;s :file:`setup.py`::</span>

<span class="sd">           setup(</span>
<span class="sd">               name=&quot;watertap&quot;,</span>
<span class="sd">               # other setup() sections</span>
<span class="sd">               entry_points={</span>
<span class="sd">                   &quot;watertap.flowsheets&quot;: [</span>
<span class="sd">                        # other flowsheet entry points</span>
<span class="sd">                        &quot;my_flowsheet = watertap.flowsheets.flowsheets.my_flowsheet&quot;,</span>
<span class="sd">                   ]</span>
<span class="sd">               }</span>
<span class="sd">           )</span>

<span class="sd">        Args:</span>
<span class="sd">            group_name: The entry_points group from which the flowsheet interface modules will be populated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mapping with keys the module names and values FlowsheetInterface objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">entry_points</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># this happens for Python 3.7 (via importlib_metadata) and Python 3.10+</span>
            <span class="n">entry_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">eps</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">group_name</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># this will happen on Python 3.8 and 3.9, where entry_points() has dict-like group selection</span>
            <span class="n">entry_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">eps</span><span class="p">[</span><span class="n">group_name</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">entry_points</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No interfaces found for entry points group: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">interfaces</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entry_points</span><span class="p">)</span><span class="si">}</span><span class="s2"> entry points&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">entry_points</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ep = </span><span class="si">{</span><span class="n">ep</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">value</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot import module &#39;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">interface</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">interface</span><span class="p">:</span>
                <span class="n">interfaces</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">interface</span>

        <span class="k">return</span> <span class="n">interfaces</span></div>

<div class="viewcode-block" id="FlowsheetInterface.from_module"><a class="viewcode-back" href="../../../apidoc/watertap.ui.html#watertap.ui.fsapi.FlowsheetInterface.from_module">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_module</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModuleType</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;FlowsheetInterface&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a a flowsheet interface for module.</span>

<span class="sd">        Args:</span>
<span class="sd">            module: The module</span>

<span class="sd">        Returns:</span>
<span class="sd">            A flowsheet interface or None if it failed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">ModuleType</span><span class="p">):</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

        <span class="c1"># Get function that creates the FlowsheetInterface</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">UI_HOOK</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Interface for module &#39;</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">&#39; is missing UI hook function: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">UI_HOOK</span><span class="si">}</span><span class="s2">()&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Call the function that creates the FlowsheetInterface</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">interface</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot get FlowsheetInterface object for module &#39;</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Return created FlowsheetInterface</span>
        <span class="k">return</span> <span class="n">interface</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../../copyright.html">Copyright</a> 2020-2024, NAWI.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>