<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to use the debugging solver wrapper &mdash; WaterTAP 1.2.dev0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=d1d7ad24"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="How to use the property test harness" href="how_to_use_property_test_harness.html" />
    <link rel="prev" title="How to use loopTool to explore flowsheets" href="how_to_use_loopTool_to_explore_flowsheets.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            WaterTAP
              <img src="../_static/NAWI_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.2.dev0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">How To Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="how_to_run_models_in_a_py_script.html">How to run models in a Python script</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_run_zero_order_model.html">How to run a zero-order model</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_use_a_property_model.html">How to use a property model</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_setup_simple_RO.html">How to setup a simple RO model</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_setup_RO_config_options.html">How to use configuration options in the RO model</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_use_MCAS_property_model.html">How to use the multicomponent aqueous solution (MCAS) property model</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_setup_simple_chemistry.html">How to setup simple chemistry</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_use_apparent_and_true_chemical_species.html">How to use apparent and true chemical species</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_use_inherent_reactions.html">How to use inherent reactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_scale_a_model.html">How to scale a model</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_scale_chemical_reactions.html">How to scale chemical reactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_scale_chemical_species.html">How to scale chemical species</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_scale_chemical_process_energy_balance.html">How to scale energy balance for chemical process</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_use_parameter_sweep.html">How to explore a model with parameter sweep</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_use_parameter_sweep_monte_carlo.html">Monte Carlo testing with the Parameter Sweep</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_run_differential_parameter_sweep.html">How to Run Differential Parameter Sweep</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_use_loopTool_to_explore_flowsheets.html">How to use loopTool to explore flowsheets</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">How to use the debugging solver wrapper</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to">How To</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-behavior-without-debugging-mode">Example behavior without debugging mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-behavior-with-debugging-mode">Example behavior with debugging mode</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="how_to_use_property_test_harness.html">How to use the property test harness</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_use_ui_api.html">Add a flowsheet to the UI</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_use_ui_api.html#testing-flowsheet-interfaces">Testing flowsheet interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_use_unit_test_harness.html">How to use the unit test harness</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_contribute_development.html">How to contribute to WaterTAP’s development</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks.html">How to run WaterTAP with Jupyter notebooks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../technical_reference/index.html">Technical Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/index.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License Agreement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">Copyright</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">WaterTAP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">How To Guides</a></li>
      <li class="breadcrumb-item active">How to use the debugging solver wrapper</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/how_to_guides/how_to_use_debugging_solver_wrapper.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="how-to-use-the-debugging-solver-wrapper">
<span id="how-to-use-debugging-solver-wrapper"></span><h1>How to use the debugging solver wrapper<a class="headerlink" href="#how-to-use-the-debugging-solver-wrapper" title="Permalink to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>Debugging a failed initialization or solve can be cumbersome.
Further, it is often useful to have the model state (i.e., initial variable values) from before the solve failed.
The debugging solver wrapper facilitates the following:</p>
<ol class="arabic simple">
<li><p>Stores initialization information before a failed solve</p></li>
<li><p>Upon a failed attempt to solve, the user is routed to an Interactive Python notebook where the restored model state can be accessed, <a class="reference external" href="https://idaes-pse.readthedocs.io/en/stable/reference_guides/core/util/diagnostics/diagnostics_toolbox.html">IDAES’ DiagnosticToolbox</a> is instantiated to probe the model, and the user can freely apply any other diagnostic utility functions to troubleshoot the problematic model.</p></li>
</ol>
</section>
<section id="how-to">
<h2>How To<a class="headerlink" href="#how-to" title="Permalink to this heading"></a></h2>
<p>In a python module containing the model and script to solve that model, the user would make a simple import:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">watertap.core.util.model_debug_mode</span> <span class="kn">import</span> <span class="n">activate</span>
<span class="n">activate</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you ran your python file in an interactive window, this debugging mode may not work as expected. We recommend running your python file in a terminal.</p>
</div>
</section>
<section id="example-behavior-without-debugging-mode">
<h2>Example behavior without debugging mode<a class="headerlink" href="#example-behavior-without-debugging-mode" title="Permalink to this heading"></a></h2>
<p>The example output below shows a problematic model that fails to initialize.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>2024-02-01 13:06:07 [DEBUG] idaes.solve.fs.bed_stack: EXIT: Converged to a point of local infeasibility. Problem may be infeasible.
2024-02-01 13:06:07 [DEBUG] idaes.solve.fs.bed_stack: WARNING: Loading a SolverResults object with a warning status into
2024-02-01 13:06:07 [DEBUG] idaes.solve.fs.bed_stack: model.name=&quot;fs.bed_stack&quot;;
2024-02-01 13:06:07 [DEBUG] idaes.solve.fs.bed_stack:     - termination condition: infeasible
2024-02-01 13:06:07 [DEBUG] idaes.solve.fs.bed_stack:     - message from solver: Ipopt 3.14.11\x3a Converged to a locally infeasible
2024-02-01 13:06:07 [DEBUG] idaes.solve.fs.bed_stack:       point. Problem may be infeasible.
2024-02-01 13:06:07 [INFO] idaes.init.fs.bed_stack: Initialization Step 3 infeasible - Converged to a locally infeasible point. Problem may be infeasible..
2024-02-01 13:06:07 [WARNING] idaes.init.fs.bed_stack:  The solver at the Initialization Step 3 step failed to converge to an optimal solution.This suggests that the user provided infeasible inputs or that the model is poorly scaled, poorly initialized, or degenerate.
2024-02-01 13:06:07 [INFO] idaes.init.fs.bed_stack: Initialization Complete: infeasible - Converged to a locally infeasible point. Problem may be infeasible.
Traceback (most recent call last):
File &quot;/Models/bed_simulation.py&quot;, line 439, in &lt;module&gt;
m, res = main()
File &quot;/Models/bed_simulation.py&quot;, line 53, in main
m, res = run_simulation(case, parameter_estimates)
File &quot;/Models/bed_simulation.py&quot;, line 106, in run_simulation
model_initialize(m, case)
File &quot;/Models/bed_simulation.py&quot;, line 313, in model_initialize
model.fs.bed_stack.initialize(outlvl=idaeslog.DEBUG, ignore_dof=True)
File &quot;/watertap/core/initialization_mixin.py&quot;, line 23, in initialize
return super().initialize(*args, **kwargs)
File &quot;/anaconda3/envs/watertap/lib/python3.10/site-packages/idaes/core/base/unit_model.py&quot;, line 540, in initialize
flags = blk.initialize_build(*args, **kwargs)
File &quot;/watertap/unit_models/electrodialysis_1D.py&quot;, line 2146, in initialize_build
raise InitializationError(f&quot;Unit model {self.name} failed to initialize&quot;)
idaes.core.util.exceptions.InitializationError: Unit model fs.bed_stack failed to initialize
</pre></div>
</div>
</section>
<section id="example-behavior-with-debugging-mode">
<h2>Example behavior with debugging mode<a class="headerlink" href="#example-behavior-with-debugging-mode" title="Permalink to this heading"></a></h2>
<p>Adding the aforementioned import to the module and calling <code class="docutils literal notranslate"><span class="pre">activate()</span></code> results in the printout below before being routed to an Interactive Python window:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>EXIT: Converged to a point of local infeasibility. Problem may be infeasible.
WARNING: Loading a SolverResults object with a warning status into
model.name=&quot;fs.bed_stack&quot;;
 - termination condition: infeasible
 - message from solver: Ipopt 3.14.11\x3a Converged to a locally infeasible
    point. Problem may be infeasible.

Solver debugging mode: the block fs.bed_stack failed to solve.

fs.bed_stack can be called as `blk` in debugging mode.

The solver ipopt-watertap is available in the variable `solver`.

The initial values before the failed solve have been stored.

You can restore these initial values at anytime by calling `debug.restore_initial_values(blk)`.

The model has been loaded into an IDAES DiagnosticsToolbox instance called `dt`.

WARNING: If you ran your python file in an interactive window, this debugging mode will not work as intended. Be sure to run your python file in a terminal.

Python 3.10.9 (main, Jan 11 2023, 09:18:20) [Clang 14.0.6 ]
Type &#39;copyright&#39;, &#39;credits&#39; or &#39;license&#39; for more information
IPython 7.34.0 -- An enhanced Interactive Python. Type &#39;?&#39; for help.

In [1]:
</pre></div>
</div>
<p>Check the model name with <code class="docutils literal notranslate"><span class="pre">blk</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>In<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>blk.name
Out<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span><span class="s1">&#39;fs.bed_stack&#39;</span>
</pre></div>
</div>
<p>Use the DiagnosticsToolbox (instantiated to <code class="docutils literal notranslate"><span class="pre">dt</span></code>) to probe for structural issues in the model:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>In<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span>:<span class="w"> </span>dt.report_structural_issues<span class="o">()</span>
<span class="o">====================================================================================</span>
Model<span class="w"> </span>Statistics

<span class="w">        </span>Activated<span class="w"> </span>Blocks:<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">(</span>Deactivated:<span class="w"> </span><span class="m">0</span><span class="o">)</span>
<span class="w">        </span>Free<span class="w"> </span>Variables<span class="w"> </span><span class="k">in</span><span class="w"> </span>Activated<span class="w"> </span>Constraints:<span class="w"> </span><span class="m">566</span><span class="w"> </span><span class="o">(</span>External:<span class="w"> </span><span class="m">0</span><span class="o">)</span>
<span class="w">            </span>Free<span class="w"> </span>Variables<span class="w"> </span>with<span class="w"> </span>only<span class="w"> </span>lower<span class="w"> </span>bounds:<span class="w"> </span><span class="m">136</span>
<span class="w">            </span>Free<span class="w"> </span>Variables<span class="w"> </span>with<span class="w"> </span>only<span class="w"> </span>upper<span class="w"> </span>bounds:<span class="w"> </span><span class="m">0</span>
<span class="w">            </span>Free<span class="w"> </span>Variables<span class="w"> </span>with<span class="w"> </span>upper<span class="w"> </span>and<span class="w"> </span>lower<span class="w"> </span>bounds:<span class="w"> </span><span class="m">240</span>
<span class="w">        </span>Fixed<span class="w"> </span>Variables<span class="w"> </span><span class="k">in</span><span class="w"> </span>Activated<span class="w"> </span>Constraints:<span class="w"> </span><span class="m">42</span><span class="w"> </span><span class="o">(</span>External:<span class="w"> </span><span class="m">7</span><span class="o">)</span>
<span class="w">        </span>Activated<span class="w"> </span>Equality<span class="w"> </span>Constraints:<span class="w"> </span><span class="m">566</span><span class="w"> </span><span class="o">(</span>Deactivated:<span class="w"> </span><span class="m">0</span><span class="o">)</span>
<span class="w">        </span>Activated<span class="w"> </span>Inequality<span class="w"> </span>Constraints:<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">(</span>Deactivated:<span class="w"> </span><span class="m">0</span><span class="o">)</span>
<span class="w">        </span>Activated<span class="w"> </span>Objectives:<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">(</span>Deactivated:<span class="w"> </span><span class="m">0</span><span class="o">)</span>

------------------------------------------------------------------------------------
<span class="m">1</span><span class="w"> </span>WARNINGS

<span class="w">    </span>WARNING:<span class="w"> </span>Found<span class="w"> </span><span class="m">354</span><span class="w"> </span>potential<span class="w"> </span>evaluation<span class="w"> </span>errors.

------------------------------------------------------------------------------------
<span class="m">2</span><span class="w"> </span>Cautions

<span class="w">    </span>Caution:<span class="w"> </span><span class="m">3</span><span class="w"> </span>variables<span class="w"> </span>fixed<span class="w"> </span>to<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>Caution:<span class="w"> </span><span class="m">11</span><span class="w"> </span>unused<span class="w"> </span>variables<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>fixed<span class="o">)</span>

------------------------------------------------------------------------------------
Suggested<span class="w"> </span>next<span class="w"> </span>steps:

<span class="w">    </span>display_potential_evaluation_errors<span class="o">()</span>

<span class="o">====================================================================================</span>
</pre></div>
</div>
<p>Continue to probe and diagnose model infeasibility in this Interactive Python window.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="how_to_use_loopTool_to_explore_flowsheets.html" class="btn btn-neutral float-left" title="How to use loopTool to explore flowsheets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="how_to_use_property_test_harness.html" class="btn btn-neutral float-right" title="How to use the property test harness" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../copyright.html">Copyright</a> 2020-2024, NAWI.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>